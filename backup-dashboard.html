<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup Management - MindVault</title>
    <meta name="description" content="Backup and recovery management dashboard for MindVault">
    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js?v=6"></script>
    <script src="js/config.js?v=6"></script>
    <script src="js/error-handler.js?v=6"></script>
    <script src="js/supabase-client.js?v=6"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .backup-card {
            transition: all 0.3s ease;
        }
        
        .backup-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .status-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">MindVault Backup Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="refreshBackups()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Refresh
                    </button>
                    <a href="admin-dashboard.html" class="text-gray-600 hover:text-gray-900">Back to Admin</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Backup Status Overview -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Backup Status Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="backup-card bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Backups</p>
                            <p class="text-2xl font-semibold text-gray-900" id="total-backups">--</p>
                        </div>
                    </div>
                </div>
                
                <div class="backup-card bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Last Backup</p>
                            <p class="text-2xl font-semibold text-gray-900" id="last-backup">--</p>
                        </div>
                    </div>
                </div>
                
                <div class="backup-card bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Storage Used</p>
                            <p class="text-2xl font-semibold text-gray-900" id="storage-used">--</p>
                        </div>
                    </div>
                </div>
                
                <div class="backup-card bg-white p-6 rounded-lg shadow">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Health Status</p>
                            <p class="text-2xl font-semibold text-gray-900" id="health-status">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup Actions -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Backup Actions</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="createFullBackup()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Create Full Backup
                    </button>
                    
                    <button onclick="createIncrementalBackup()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Create Incremental Backup
                    </button>
                    
                    <button onclick="cleanupOldBackups()" class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 transition-colors flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Cleanup Old Backups
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Backups -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Recent Backups</h2>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Backup ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Started</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tables</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rows</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backups-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-6 py-4 text-center text-gray-500">Loading backups...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Restore Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Restore from Backup</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Backup to Restore</label>
                    <select id="restore-backup-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select a backup...</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="restoreFromBackup()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Restore from Backup
                    </button>
                    <p class="text-sm text-gray-600">⚠️ This will overwrite current data. Use with caution.</p>
                </div>
            </div>
        </div>

        <!-- Backup Settings -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Backup Settings</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Retention Period (days)</label>
                        <input type="number" id="retention-days" value="30" min="1" max="365" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">How long to keep backups before automatic cleanup</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Auto Backup Schedule</label>
                        <select id="backup-schedule" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="disabled">Disabled</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Automatic backup frequency</p>
                    </div>
                </div>
                <div class="mt-6">
                    <button onclick="saveBackupSettings()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-3 text-gray-700" id="loading-message">Processing...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;

        async function initBackupDashboard() {
            try {
                await loadBackupOverview();
                await loadRecentBackups();
                await loadRestoreOptions();
                
                // Set up auto-refresh
                refreshInterval = setInterval(refreshBackups, 30000); // Refresh every 30 seconds
            } catch (error) {
                console.error('Failed to initialize backup dashboard:', error);
            }
        }

        async function refreshBackups() {
            try {
                await loadBackupOverview();
                await loadRecentBackups();
                await loadRestoreOptions();
            } catch (error) {
                console.error('Failed to refresh backups:', error);
            }
        }

        async function loadBackupOverview() {
            try {
                // Get backup statistics
                const { data: backups } = await window.supabaseClient
                    .from('backup_logs')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (backups && backups.length > 0) {
                    const totalBackups = backups.length;
                    const completedBackups = backups.filter(b => b.status === 'completed').length;
                    const lastBackup = backups[0];
                    
                    document.getElementById('total-backups').textContent = totalBackups;
                    document.getElementById('last-backup').textContent = 
                        lastBackup ? new Date(lastBackup.started_at).toLocaleDateString() : 'Never';
                    document.getElementById('health-status').textContent = 
                        completedBackups === totalBackups ? 'Healthy' : 'Issues';
                    
                    // Calculate storage used (simplified)
                    const { data: tableBackups } = await window.supabaseClient
                        .from('table_backups')
                        .select('row_count');
                    
                    const totalRows = tableBackups ? tableBackups.reduce((sum, tb) => sum + tb.row_count, 0) : 0;
                    document.getElementById('storage-used').textContent = `${totalRows.toLocaleString()} rows`;
                } else {
                    document.getElementById('total-backups').textContent = '0';
                    document.getElementById('last-backup').textContent = 'Never';
                    document.getElementById('storage-used').textContent = '0 rows';
                    document.getElementById('health-status').textContent = 'No Backups';
                }
            } catch (error) {
                console.error('Failed to load backup overview:', error);
            }
        }

        async function loadRecentBackups() {
            try {
                const { data: backups } = await window.supabaseClient
                    .rpc('list_backups', { limit_count: 10 });

                const tableBody = document.getElementById('backups-table');
                
                if (backups && backups.length > 0) {
                    tableBody.innerHTML = backups.map(backup => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${backup.backup_id}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                    backup.backup_type === 'full' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                                }">
                                    ${backup.backup_type}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                    backup.status === 'completed' ? 'bg-green-100 text-green-800' : 
                                    backup.status === 'failed' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                                }">
                                    ${backup.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${new Date(backup.started_at).toLocaleString()}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${backup.duration ? Math.round(backup.duration.total_seconds) + 's' : '--'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${backup.tables_backed_up}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${backup.total_rows.toLocaleString()}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="viewBackupDetails('${backup.backup_id}')" class="text-blue-600 hover:text-blue-900">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">No backups found</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Failed to load recent backups:', error);
            }
        }

        async function loadRestoreOptions() {
            try {
                const { data: backups } = await window.supabaseClient
                    .from('backup_logs')
                    .select('backup_id, backup_type, started_at')
                    .eq('status', 'completed')
                    .order('started_at', { ascending: false });

                const select = document.getElementById('restore-backup-select');
                select.innerHTML = '<option value="">Select a backup...</option>';
                
                if (backups && backups.length > 0) {
                    backups.forEach(backup => {
                        const option = document.createElement('option');
                        option.value = backup.backup_id;
                        option.textContent = `${backup.backup_id} (${backup.backup_type}) - ${new Date(backup.started_at).toLocaleDateString()}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load restore options:', error);
            }
        }

        async function createFullBackup() {
            try {
                showLoading('Creating full backup...');
                
                const { data, error } = await window.supabaseClient
                    .rpc('create_full_backup');
                
                hideLoading();
                
                if (error) {
                    alert('Failed to create backup: ' + error.message);
                } else {
                    alert('Full backup created successfully: ' + data);
                    await refreshBackups();
                }
            } catch (error) {
                hideLoading();
                console.error('Failed to create full backup:', error);
                alert('Failed to create backup: ' + error.message);
            }
        }

        async function createIncrementalBackup() {
            try {
                showLoading('Creating incremental backup...');
                
                const { data, error } = await window.supabaseClient
                    .rpc('create_incremental_backup');
                
                hideLoading();
                
                if (error) {
                    alert('Failed to create incremental backup: ' + error.message);
                } else {
                    alert('Incremental backup created successfully: ' + data);
                    await refreshBackups();
                }
            } catch (error) {
                hideLoading();
                console.error('Failed to create incremental backup:', error);
                alert('Failed to create incremental backup: ' + error.message);
            }
        }

        async function cleanupOldBackups() {
            try {
                const retentionDays = parseInt(document.getElementById('retention-days').value) || 30;
                
                if (!confirm(`Are you sure you want to delete backups older than ${retentionDays} days?`)) {
                    return;
                }
                
                showLoading('Cleaning up old backups...');
                
                const { data, error } = await window.supabaseClient
                    .rpc('cleanup_old_backups', { retention_days: retentionDays });
                
                hideLoading();
                
                if (error) {
                    alert('Failed to cleanup old backups: ' + error.message);
                } else {
                    alert(`Cleaned up ${data} old backups`);
                    await refreshBackups();
                }
            } catch (error) {
                hideLoading();
                console.error('Failed to cleanup old backups:', error);
                alert('Failed to cleanup old backups: ' + error.message);
            }
        }

        async function restoreFromBackup() {
            try {
                const backupId = document.getElementById('restore-backup-select').value;
                
                if (!backupId) {
                    alert('Please select a backup to restore from');
                    return;
                }
                
                if (!confirm('Are you sure you want to restore from this backup? This will overwrite current data.')) {
                    return;
                }
                
                showLoading('Restoring from backup...');
                
                const { data, error } = await window.supabaseClient
                    .rpc('restore_from_backup', { restore_backup_id: backupId });
                
                hideLoading();
                
                if (error) {
                    alert('Failed to restore from backup: ' + error.message);
                } else {
                    alert('Restore completed successfully: ' + data);
                    await refreshBackups();
                }
            } catch (error) {
                hideLoading();
                console.error('Failed to restore from backup:', error);
                alert('Failed to restore from backup: ' + error.message);
            }
        }

        async function viewBackupDetails(backupId) {
            try {
                const { data, error } = await window.supabaseClient
                    .rpc('get_backup_status', { backup_id_param: backupId });
                
                if (error) {
                    alert('Failed to get backup details: ' + error.message);
                } else if (data && data.length > 0) {
                    const backup = data[0];
                    alert(`Backup Details:\n\nID: ${backup.backup_id}\nType: ${backup.backup_type}\nStatus: ${backup.status}\nStarted: ${new Date(backup.started_at).toLocaleString()}\nDuration: ${backup.duration ? Math.round(backup.duration.total_seconds) + 's' : 'N/A'}\nTables: ${backup.tables_backed_up}\nRows: ${backup.total_rows.toLocaleString()}`);
                }
            } catch (error) {
                console.error('Failed to get backup details:', error);
                alert('Failed to get backup details: ' + error.message);
            }
        }

        async function saveBackupSettings() {
            try {
                // In a real implementation, you would save these settings to a configuration table
                const retentionDays = document.getElementById('retention-days').value;
                const schedule = document.getElementById('backup-schedule').value;
                
                alert('Backup settings saved successfully!');
            } catch (error) {
                console.error('Failed to save backup settings:', error);
                alert('Failed to save backup settings: ' + error.message);
            }
        }

        function showLoading(message) {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-modal').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-modal').classList.add('hidden');
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initBackupDashboard);

        // Clean up interval on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
